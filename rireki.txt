青空文庫リーダー
    GPL2
    ベータバージョン
    ２０１３年７月２７日、　２０１２年９月２日、  ２０１４年１２月７日
    ２０１５年２月１７日

    概要
        青空文庫(http://www.aozora.gr.jp)のテキストファイルをPython(CPython)と
        gtk+2.0とPangoを用いて縦書き表示で読もう、というものです。

    開発及び動作確認環境
        LinuxMint 17.3
            pygtk及び関連ライブラリ一式
            TakaoEx明朝
            TakaoExゴシック
            花園明朝A,B
        以前はPuppyLinux(precise puppy 571JP)で開発していました。ubuntu系の
        派生ディストリビューションであればだいたい動作すると思います。

    既知の問題点
    表示
    ・“”は内容が和文の場合ノノカギ〝〟に変換しますが、閉じられていない
    　場合はそのままです。
    ・ラスタライザから情報をもらっていないため、次の制限があります。
        斜体を使った場合、文字幅は適切になりません。
        デスクトップの解像度（DPI）を斟酌しません。
        特定のフォントに強く依存しています。
    ・縦書き用の字形を持たないフォントでは正しく表示されません。(M+1P+IPAG等)
    ・unicode にもJISにもない文字は原則としてタグのままとなります。
    ・使用するフォントはTakaoEx明朝及び花園明朝A・Bの併用を想定しています。
    　これら以外の組み合わせでは（ただでさえ酷い）表示が（さらに）崩れる場合が
    　あります。
    構成
    ・窓見出しは同行見出しと同様の扱いになります。
    ・ルビ、注記、返り点・訓点送りがな、割り注、キャプション類では禁則処理を
    　斟酌しません。手抜きです。
    ・右ページ、左ページの概念がありません。このため、改ページと改丁は同じ意味と
    　なります。
    ・ネストしたタグは正しく処理されない場合があります。
    ・画面の都合で１行に収まらない割り注は、割り注をキャンセルして少し文字を
    　小さくして１行で表示されます。
    ・扱えるのは青空文庫のサイトにアップロードされているテキストファイルのみです。
    　これ以外の形式、及びサイト外を参照しているファイルは開くことができません。
    　また、青空文庫の形式に準拠していない構成のテキストファイルは正しく表示され
    　ません。
    目次・履歴
    ・途中に一度も空行（改行のみの行）が出現しないテキストにおいては、目次が
    　作成されません（全てヘッダ扱いとなる為）。
    ・読書履歴（しおり機能）に解像度や文字の大きさの情報を持たせていないため、
    　これらの設定を変更した後、しおりを開くと意図しないページが表示されます。
    その他
    ・デバッグ用のメッセージ出力がそのままになっています。

    表示処理用に用意したタグ
        属性にsizeを使うと段落構成（1行の文字数のカウント）に支障がでます。
        <span>との弁別を省略しているためです。
        詳細はソースをご覧ください。
        <aozora img>            段落内に挿入される画像
        <aozora img2>           独立した段落に挿入される画像
        <aozora caption>        画像のキャプション
        <aozora bousen>         傍線
        <aozora bouten>         傍点
        <aozora tatenakayoko>   縦中横
        <aozora warichu>        割り注
        <aozora rubi>           ルビあるいは注記
        <aozora dash>           ダッシュの連結
        <aozora half>           １文字の送り量（全角を１とする比率）
        <aozora ofset>          文字開始位置調整（ピクセル値）
        <aozora adj>            文字送り量調整（ピクセル値）
        <aozora leftrubi>       左ルビあるいは左注記
        <aozora leftbouten>     左傍点
        <aozora leftbousen>     左傍線
        <aozora keikakomigyou>  罫囲み（行中）
        <aozora keikakomi>      罫囲み（段落）
        <aozora yokogumi>       横組
        <aozora yokogumi2>      横組その２（表示ルーチン内で自動的に付加）
        <aozora mado>           窓見出し（の一部）

    開発履歴
    ２０１７年６月２日
        ・表示フォント選択時に本文側のフォントサイズが正しく設定されないバグを修正。

    ２０１７年６月１日
        ・いつのまにか囲み罫線が動作しなくなっていたバグを修正。

    ２０１７年５月２２日
        ・本文における１文字の高さ、幅をフォントサイズから安易に計算していたのを、実際に
        　pangocairoで描画して求める方法に変更。この際、改行幅の掛率を1.5->1.0に変更。

    ２０１７年５月２１日
        ・英数字の文字幅を、Takao明朝に基づいた固定値としていたものを各々のフォントの実際の表示
        　幅に基づいて動的に求める方法に変更。これにより、フォントを変更した場合での見た目が改善
        　されています。
        　計算はフォーマット時に１回、表示ルーチンで表示の都度１回行われます。これは、表示ルーチン
        　をメモリリーク解決の為、サブプロセスにして１ページ表示毎に使い捨てている為です。
        　余計な処理が増えたことで、遅いハードではさらに実用性が損なわれているかも知れません。

    ２０１７年５月１７日
        ・キャプションの改行処理を表示ルーチン(cairocanvas.py)からフォーマッタ(formater.py)
        　に移動。この際、表示段階で行っていた画像サイズの再計算を廃止。（フォーマット時に
        　タグに埋め込む。）

    ２０１７年５月１４日
        ・禁則処理の際、行末に全角閉じ括弧類が置けるにも関わらず次行に追い出されてしまうバグを
        　修正。

    ２０１７年５月８日
        ・フォントによっては縦中横での送り量が適切に処理されないバグを修正。
        ・青空文庫側の入力ミスにより、底本注記の処理で無限ループに陥るバグに暫定対応。
        　具体的には、［＃底本では「ほげほげ」は「ふがふが」］の「ほげほげ」が前方に存在しないと
        　無限ループに陥って、最終的にはメモリを使い切ってシステムを落とします。
        　現在、芥川龍之介「羅生門」旧字旧仮名にてこの問題を確認しています。

    ２０１７年５月７日
        ・ノンブル及び柱にフォント設定が反映されていなかったバグを修正。
        ・ルビ位置及び傍点位置の調整機能を追加。

    ２０１６年１１月６日
        ・行末禁則処理時に、禁則文字の後続にタグがあるとうまく処理されない場合があるバグを修正。

    ２０１６年１１月５日
        ・ネットワークへの接続状況の検出処理を追加。
        ・履歴や栞に残っているのに該当するファイルが存在しない場合、エラー停止してしまうバグを
        　修正。

    ２０１６年１０月２７日
        ・新着情報にて、複数ファイルを選択できるようにしました。
        ・新着情報の取得先URLがコード埋め込みであったのを、設定ファイルに移動しました。
        　このため設定ファイルのバージョンを変更したので、初回起動時に既存設定が初期化されます。

    ２０１６年１０月１５日
        ・非unicode文字出現時、デバッグメッセージの出力に失敗してエラーになってしまうバグを修正。

    ２０１６年１０月８日
        ・一部のLinuxディストリビューション(例えばSlitaz rolling 32bit)において、
         unichrの実装上の都合で表示できないテキストがありました。unichrによる文字変換の際
         エラーが生じて動作が停止するというものです。
         原因はunichrが0xffff以上の引数を受け付けないことに依ります。仕方ないので、このような
         場合は青空文庫のタグをそのまま表示するようにしました。

         参考URL http://docs.python.jp/2/library/functions.html#unichr

    ２０１６年６月５日
        ・新着情報からテキストをダウンロードする際、web上に複数のzipファイルが登録されていると
        　全てをダウンロードした挙句、最後のzipにテキストファイルが含まれていないとエラーに
        　なってしまうバグを修正。
        　テキストファイルの展開後、残りのzipを読まずに終わります。

    ２０１６年５月１５日
        ・ママの表示が、ルビがない場合に本文より離れてしまうバグを修正。

    ２０１６年４月２３日
        ・キャプションの種類によって、ページ末の行が表示されなくなるバグを修正。

    ２０１６年４月１８日
        ・キャプション内で & < > が表示できないバグを修正。

    ２０１６年４月１７日
        ・単純な置換に何故か正規表現を使っていた部分を修正。

    ２０１６年４月１３日
        ・本文中の & < > が表示されないバグを修正。尚、キャプション中にこれらが出現した
        　場合は、その位置から文末までが表示されません。
        　これは、PythonのHTMLParserが & < > 及び &amp;等が出現した場合、それらを
        　トラップし、送り込まれた文字列をそこで分断して処理する為です。
        　キャプションは１行（複数行からなるキャプションも１行に連結している）であることを
        　前提に処理ルーチンを組んでいるので、分断されて生じる２行目以降は表示できません。

    ２０１６年３月２８日
        ・<aozora yokogumi2>(横組その２)の付加が原因でダッシュが正しく表示されない
        　バグを修正。

    ２０１６年３月２７日
        ・README.md を改変。開発環境をPuppyLinuxからLinuxMintに変更。
        ・ダッシュが改行時に正しく表示されないバグを修正。

    ２０１６年３月２０日
        ・キャプションが続くかどうか不明な挿図について、キャプションが表示されなかったバグを
        　修正。

    ２０１６年３月１７日
        ・環境によっては、作者情報の検索の引数に空白が含まれるとうまく検索できないバグを修正。

    ２０１６年３月１３日
        ・縦中横出現時に地付き等が正しく表示されないバグを修正。
        ・ダッシュ表示の際、途切れて表示されるバグを修正。

    ２０１６年３月７日
        ・キャプションなしの図が出現した際、そのページの最終行が次頁の先頭にも表示される
        　バグを修正。

    ２０１６年２月２９日
        ・キャプション付きの図が正しく検出されなかったバグを修正。
        ・行末に'\r'(CR)が付された場合の処理が、'\n'と変わらなかった点を修正。

    ２０１６年２月２８日
        ・キャプションの表示に禁則処理を導入。
        ・キャプションの表示位置にセンタリングを導入。
        ・挿図とキャプションとの間に何か挟まっているとキャプションが表示されないバグを修正。
        ・キャプションのない挿図に対し、テキストを回りこみ表示させるよう修正。

    ２０１６年２月２５日
        ・URLのワードラップを抑止。
        ・正規表現の作成でエラーになるバグを修正。

    ２０１６年２月２０日
        ・二重山括弧の代替に算術記号を使っているテキストへ対策。

    ２０１６年２月１８日
        ・キャプション周辺の処理を改変。

    ２０１６年２月１５日
        ・キャプションの処理を復活。なおも修正中なのでデバッグメッセージを吐きます。

    ２０１６年１月３１日
        ・複数行からなるキャプションの処理を暫定的に割愛。

    ２０１６年１月２６日
        ・挿図の際、次頁の先頭１行が欠けるバグを修正。

    ２０１６年１月１日
        ・XHTML形式で登録されているテキストをとりあえず開けるように修正。
        　xdg-open に単純に展開したファイル (hoge.html)を渡すので、挙動は環境依存に
        　なります。

    ２０１５年１２月２３日
        ・行末禁則文字が連続して出現すると、後ろから２文字以降が次行先頭へ送り込まれなかった
        　バグを修正。

    ２０１５年８月２６日
        ・丸傍点表示がエラー終了してしまうバグを修正。
        ・縦中横で組まれた文字に傍線や傍点が正しく表示されなかったバグを修正。

    ２０１５年７月６日
        ・太字表示の際のフォント設定を追加。但し、サイズは無視されます。

    ２０１５年７月２日
        ・WSVGA(1024x600,ネットブックなど)選択時の表示領域を修正。F11押下による
        　全画面表示使用時にちょうど良い大きさになります。
        ・文字サイズを極端に大きくした際、英文ワードラップに失敗し無限ループに
        　陥る件について、既知の問題点として掲示。

    ２０１５年５月１６日
        ・新着情報からのダウンロードをキャンセルした際、ダイアログへ戻るように
        　変更。従来は既存のファイルを開いていました。
        ・3択ダイアログ(Yes,No,Cancel)を追加。

    ２０１５年５月１２日
        ・（右）注記の親文字にルビを含む場合、ルビと結合して２行表示とするよう
        　変更。
        ・底本注記が繰り返して表示されるバグを暫定修正。
        ・横組み表示の処理が不適切で行頭のタグが動作しないバグを修正。

    ２０１５年５月１１日
        ・注記として〔〕が付与された際の表示位置を調整。
        ・底本注記の際、対象にタグが含まれるとうまく表示できないバグを修正。
        ・連続するルビの表示位置を調整する際、左右互いに干渉していたバグを修正。
        ・空白の含まれるルビの分割に失敗していたバグを修正。
        ・割り注が次行に分割される際、行頭禁則文字の持ち越しを回避。

    ２０１５年５月１０日
        ・傍点類をcairoで描画するように変更しました。

    ２０１５年５月８日
        ・ルビや注記が繰り返し表示されてしまうバグを修正。
        　親文字に括弧や句読点が含まれる場合、これらが送り量調整の対象となり
        　タグを付されることで、１文字単位で表示されるのが原因です。
        　　模式文字列 <rubi><adj>「</adj>親文字</rubi>
        　　この例の場合、"「"表示の際にrubiが呼び出され、次の"親文字"表示でも
        　　呼び出されます。
        　ルビであれば親文字に句読点類や括弧類を含むことは少ないと思います。
        　注記の場合は問題が生じるかも知れません。
        ・底本からの変更を示す注記を、左注記として表示するようにしました。
        　但し、ルビに関しては省略します。

    ２０１５年５月７日
        ・ルビ表示でエラーとなるバグを修正。
        ・外字（Shift-jis未収録文字）の置換をre.sub に変更。
        ・傍点と傍線の描画ルーチンを分離。
        ・注記には〔〕を付すことでルビと区別していますが、その際、既存の（）を
        　外すようにしました。

    ２０１５年５月６日
        ・罫囲み（行中）を実装。
        ・左傍線の処理を（右側）傍線処理に統合。
        ・波形傍線（波線）を実装。
        ・ワードラップの際、無限ループに陥ることがあるバグを修正。
        ・（新旧仮名遣い別など）同名且つ別作品を同じものと判断して開けなかった
        　バグを修正。
        ・３文字以上連なるダッシュの連結描画に対応。
        ・左ルビを追加。
        ・左注記に〔〕を付加して表示するように変更。
        ・左ルビ（注記）の描画処理をルビ（注記）に統合。
        ・割り注が行末にかかった際、1行に変換して表示するのを取りやめ。次行へ
        　分割表示するように暫定実装。

    ２０１５年５月５日
        ・ダッシュの描画をフォントからcairoへ変更。
        ・タグが前方参照する際、<>や［＃］を無視していたのを状況に応じて
        　チェックするように変更。
        　具体的には［＃「hoge」はfuga］にて、hoge に<>や［＃］が含まれる場合
        　検出対象とする。
        ・新着情報ダイアログで、作品未選択でOKをクリックするとエラーになって
        　しまうバグを修正。
        ・柱に副題が表示されないバグを修正。
        ・「インデックスによる検索」ダイアログにて、作品を選択しないで開くを
        　クリックするとメッセージを表示後すぐにhideしていたものを修正。

    ２０１５年５月４日
        ・行の折り曲げ処理を文字列からリストへの変更処理をとりあえず完了。
        ・文字列長の計算の際、連続して出現する括弧の送り量調整を反映。
        　地付きの際、浮き上がってしまうバグを回避します。
        ・半角数字の文字幅（全角文字を１とする比率）を調整。
        ・行の分割が行われない時、行末調整を実施する処理を追加。
        ・タグの移動の際、ゴミが残ったバグを修正。

    ２０１５年５月２日
        ・ワードラップ後にダブルクォーテーションの位置が狂うバグを修正。
        ・ウィンドウタイトルに表示するアイコンを仮設定。

    ２０１５年４月
        新規導入したもの
            ・ワードラップを暫定的に実装。
            ・括弧類が連続して出現した場合の送り量の調整処理を追加。後続の括弧
            　との間隔が間延びするのを回避します。
            　副作用として括弧が含まれる文の地付きが機能しません。
            ・漢数字（〇一二三四五六七八九）中の位取り（、）の送り量を半分に
            　調整。
            ・行末における … —(U+2015 EM DASH) ‥ ―(U+2015 HORIZONTAL BAR)の
            　分離を禁止。但し、フォントの都合でDASHやBARは切れて表示されます。
            ・左注記（本則）に暫定対応。
            ・右側注記の際、テキストに亀甲括弧があれば外してから表示するように
            　変更（表示処理の際、付加するため）。
            ・窓見出しを暫定実装。同行見出しと同様の扱いとなります。
            ・デフォルトのディレクトリ($HOME/aozora)にある、拡張子がtxtあるいは
            　TXTでshift-jisで書かれたファイルを開けるようにしました。間に合わ
            　せのZIPファイルを作成します。
            ・ローマ数字に対応。
            ・底本とのレイアウトの違いから、割り注が行末からはみ出してしまう件に
            　ついて対策。割り注を解除して１行で表示するようにしました。

        プログラム上の変更点
            ・文字幅情報に合字を追加。
            ・ルビにママがつく場合、２行表示とするよう変更。
            ・描画ルーチンまでそのままで渡していた
                ［＃ここから罫囲み］［＃ここで罫囲み終わり］を
                <aozora keikakomi="start"> <aozora keikakomi="end">に置換。
            ・モジュールを整理
            ・見出し処理について、複数行に及ぶものと単一行で終わるものとの
            　処理ルーチンを分離。
            ・開始／終了型の処理を整理。
            ・一緒のモジュールにあった、フォーマッタと描画ルーチンを別々の
            　モジュール(formater, cairocanvas)に分割。

        バグフィックス
            ・描画ルーチンで時折タグのバランスがとれず文面が表示されない。
            ・柱及びノンブルを変更。
            ・行右小書きで縦中横が使われた際、文字高がnormalのままである。
            ・行末揃えを改善。但し、まだ完全ではない。
            ・同行中に出現する字上げが段落全体にかかる。
            ・行頭禁則文字に全角ピリオドが含まれていない。
            ・割り注内での任意位置での改行指示が反映されない。
            ・表示段階における横組み指定がうまく解除されない。
            ・モジュール分割に伴うバグを修正。
            ・縦中横で括られた中に横書き文字があると全体が重複して表示される。
            ・修飾が多重に施される場合、期待通りの表示にならない。
            　具体的には
                見出し内部で縦中横等が出現した場合、見出しが表示されない
            ・割り注の表示に失敗してエラーとなり、そのページが落丁してしまう。
            　状況
                ［＃割り注］本文［＃割り注終わり］を検出すると
                <aozora warichu="本文">割り注実施後の表示分に相当する空白</aozora>
                に変換するのですが、この際、本文 に タグ<aozora></aozora>が含まれ
                ているとうまくパースできずにエラーとなります。具体的には属性の
                引数のダブルクォーテーション " のペアマッチがうまくいきません。
                これは <aozora warichu>において xml 本来の使い方を逸脱している
                （本文を属性にしている）からです。どうしてこうしているかというと、
                行折り返し時の処理が簡単になるからです。割り注以外にも行途中に挿入
                される画像もこのようにしています（もともと本文がないので）。
            　対策
                hoge 内に '<aozora'及び'<span'を検出した場合は割り注処理を諦めて
                通常表示にしています。エラーの原因は属性の有無にありますので、
                <sup>や<sub>等の属性をとらないタグは通しています。
            ・キャプションが正しく表示されないことがある。
            ・ダブルクォーテーションのノノカギへの変換の際、括られた内容が
            　横書きの場合でも変換していた。
            　（縦中横や左注記、割り注が含まれるとノノカギになります）
            ・白ゴマ傍点, ばつ傍点, 傍点　以外の文字で傍点を付した際、開始位置
            　が上にずれる。
            ・傍点とルビが同時に掛かる場合、重ねて表示される。
            ・tahrpuppy において、xdg-open の引数が空白で分かたれる仕様に対応。
            　""で囲っただけなので、precise puppy 等ではそのまま渡されます。

    ２０１５年３月
        新規導入したもの
            ・全画面表示(F11)を追加。単にウィンドウを拡大するだけで、表示領域
            　が変化する訳ではありません。
            ・作品の関連人物（著者、翻訳者）のウェブサーチ機能を追加。
            ・キャプションタグの開始/終了型を実装。

        プログラム上の変更点
            ・<sub>, </sup>出現時の換算文字サイズをnormal から smallに変更。
            ・ログの表示が忙《せわ》しなかったのを修正。
            ・ページ表示をウィンドウタイトルから本文画面左上に移動。
            ・JIS未定義外字変換をUnicodedata.lookup から unichr に変更。
            ・キー割り当てを一部変更。UIマネージャに取り込んで、 コールバック
            　関数を整理。
            ・ダウンロードルーチンを改変。
            ・クラスメンバの難読化を実施。typoの可能性あり。
            ・傍点の種類に応じてフォントサイズを本文とルビいずれかに切り替え。
            ・左ルビ位置指定がコメント落ちしていたのを修正。
            ・計算式のままだった定数を単一の定数に置換。
            ・既存の関数への中継だけだったコールバック関数を lambda に置換。
            ・設定ファイル(aozora.conf)に青空文庫インデックスファイルのURLを
            　追加。
            ・テキスト選択ダイアログを変更。
            ・関連付け検索機能を追加。現在開いているテキストの作者、翻訳者、
            　校正者をキーにして検索します。
            ・カレントテキストに作品IDを保持するように変更。
            ・メニュー項目の動的生成部分をクラスへ抜き出し。
            ・表示ルーチンの一部改変。特に修飾のない文字でも描画開始まで8回の
            　if判定を通過していたものを1回で済むように変更。
            ・履歴を動的生成に変更。直前に参照したテキストが最上位にくるように
            　なりました。

        バグフィックス
            ・タグのネスティングが正しく処理されない。
            ・リガチャ処理の際、変換が生じなかった場合に〔〕がおかしくなる。
            ・スタックの空読みを行って処理が止まる。
            ・訓点が出現する文章でルビがうまくかからない。
            ・しおりを登録する際、ページ番号がずれていた。
            ・ページ番号のずれ。
            ・画面サイズの検出に失敗する。
            ・再起動時、テキストの読み込みに失敗するバグ。
            ・ダイアログの破壊を検出せず、再度表示しようとした際セグる。
            ・インデックスファイルのZIPがあると、CSVの有無に関わらず展開しない
            　で戻る。
            ・ルビや割り注等においてGravity指定のタイミングが間違っている。

    ２０１５年２月
        試験導入したもの
            ・テキストオープンダイアログの試験的な差し替え。
            ・画像のキャプションを暫定的に横書きに変更。プログラムの構造上、
            　画像の直後で改ページしていたりするとキャプションが表示されません。
            ・画像直下に複数行からなるキャプションの横書き表示に対応。かなり、
            　強引に処理しています。ルビ等の修飾があるとおそらく失敗します。
            ・ルビの衝突について、後続の開始位置を繰り下げることでとりあえず
            　回避するようにしました。たくさん続くとどこにかかっているか分か
            　らなくなります。また最後は行からはみ出してしまいます。
            ・比較的使用頻度の高い合字を表示するようにしました。
                !!! (感嘆符３つ)  IIII (ローマ数字４の代替)

        新規導入あるいは追加導入したもの
            ・新規に実装したタグ
                    行左注記、割り注、横組み
            ・段落中の埋め込み画像に対応。
            ・文字幅補正にリガチャ（アクセント分解）分を追加。
            ・設定ファイルにフォントサイズのピクセル換算値を追加。
            ・縦中横の表示位置の自動補正を実装。
            ・キーボードショートカット及びメニュー項目を追加。
                しおりを挟む。         CTRL_D、ページ(P)->しおりを挟む(D)
                ページ指定ジャンプ     CTRL_J

        仕様変更
            ・画像表示の際の横幅制限を解除。大きさは表示領域の高さのみに制限
            　されます。
            ・二重山括弧の代わりに使われることの多い二重不等号を縦書き時の場合
            　二重山括弧へ置換するようにしました。レンダリング時に逐次行う為、
            　処理速度的に我慢の限界を越えています。
            ・アクセント分解で予約されていた〔〕を表示できるように修正。

        プログラミング上の変更点（新たなるバグの源とも）
            設定ファイル関係
            ・設定ファイルが非互換になってしまいました。起動に失敗する場合は、
            　~/.config/aozora/aozora.conf を削除して再度起動してください。
            　参照ディレクトリ関係を変更。起動しない場合は、
                $HOME/.cache/aozora
                $HOME/.config/aozora
                以下を削除して見てください。
            表示関係
            ・ダイアログの挙動を変更。呼び出し側が閉じればいっしょに終了するよ
            　うにしました。
            ・ログビューワを自動更新スタイルに変更しました。
            ・縦書き時に問題のあるPango(以下オリジナルPango)を使用した場合、
            　描画が破綻するケースがあったので、描画ルーチン側(class expango)
            　で対策。
            ・画像キャプションをセンタリング。
            ・cairo の取扱いにwithを導入。
            ・起動時の表紙画面の描画を本文処理ルーチンに変更。
            ・フォントサイズとピクセルとの換算比を 16./12. に変更。
            　即ち、ピクセルサイズ = round(フォントサイズ * (16./12.))
            ・ルビ表示を逐次処理に変更。
            ・ルビ表示行を廃止。
            ・レンダリング用タグを従来のpangoタグそのままから、独自タグの追加
            　拡張を実施。
            ・傍線の描画方法をフォントからcairoでの線引きに変更。但し、波線を
            　実装していません。
            ・ルビ表示位置を掛かり先頭から中央に変更。
            ・１行あたりの文字量について、フォーマッタで算出したものと実際の
            　表示でずれが生じる場合があるが、表示側(Pangocairoのlayout)から
            　ピクセル量を取得する方法で回避。
            ・文字サイズ変更時の換算倍率を調整。公比1.2とし、実際に表示して
            　ずれ具合を見ながら微調整しました。
            ・pango のメモリリークを回避するべく、レンダリングルーチンをサブ
            　プロセスに分離。
            ・フォーマッタにプログレスバーを備えたUIを用意。
            その他
            ・文字列編集処理の一部をリストとjoinに書き換えました。
            ・メモリ節約のため、レンダリングオブジェクトを使い捨てに変更。
            ・メモリ節約のため、フォーマッタを使い捨てに変更。これに伴い、
            　カレントテキストの情報を保持するクラスを作成して、フォーマッタ
            　より分離。
            ・レンダリング時の基準線をベースラインからセンターラインへ変更。
            ・履歴、しおりにZIPファイル名を記録するように変更。
            ・テキストファイルの展開先をキャッシュディレクトリ以下に変更。
            ・設定ファイルのバージョンをチェックし、必要であれば強制アップデー
            　トするように変更しました。
            ・タグの生成の一部を正規表現から辞書に変更。
            ・使わなくなったダイアログのモジュールファイル(aozoracard.py,
            　booklist.py)をリポジトリより削除。

        バグフィックス
            ・行分割時のタグ処理のバグを修正。ルーチンをかなり書き換えたので、
            　新しいバグを呼び込んでいる可能性もあります。
            ・描画色指定のバグを修正。
            ・Pangoバグ対策ルーチンのバグを修正。
            ・再起動時にテキストを開けなかったバグを修正。
            ・地付き処理のバグを修正。
            ・字上げ時の文字カウントのバグを修正。
            ・参照ディレクトリがないと起動できないバグを修正。
            ・しおり機能が正常終了しなかったバグを修正。
            ・履歴機能のバグを修正。
            ・フォントサイズ設定のバグを修正。
            ・一部文字が重力を振り切ってしまうバグを修正。
            ・レンダリング時に不要な改行コードが送られていたバグを修正。
            ・行末におけるルビ、左注記、挿入画像の分かち書きのバグを修正。
            ・傍点等が次行にまたがった場合、次行行頭の空白（字下げ等）にも効
            　果を及ぼしていたバグを修正。
            ・画像表示処理ルーチンの書き直し。

    ２０１５年１月
        新規導入あるいは試験導入したもの
        ・罫囲みに暫定対応。罫囲み内部で1文字分字下げするのが普通らしいの
        　ですが、字下げや字詰処理との兼ね合いもあり、罫囲みのほうを広げる
        　ことで見栄えを修正しています。
        　なお、１行単位での囲みは実装していません。段落単位のみとなります。
        ・アクセント分解に暫定対応。〔〕が不完全だと正しく動作しません。
        　本文中の〔〕は表示されません。
        ・いわゆるASCII文字について、Serif(TakaoEx明朝)使用時の文字幅を
        　対全角比で持たせることにしました。これにより、ローマ字が混ざる
        　文章でのレイアウトが改善します。（但し引き続きルビは崩れます。）
        ・文字の大きさや幅が変更になった場合における、１行あたりの文字数の
        　調整を試験的に導入。（セリフフォントのみ対応）
        ・画面設定変更直後からの再起動を追加。
        ・テキストフォーマット時、ウィンドウタイトルに経過を表示。
        ・メニューのツール(T)をページ(P)に変更し、先頭ページ及び最終ページへの
        　遷移を追加。
        ・先頭ページ及び最終ページへの遷移の際、テキストが開かれているか否かの
        　チェックを追加。
        ・改見開きを追加。但し、改ページと同じ扱い。
        ・改段に対応。但し改ページと同じ扱いです。
        ・青空文庫の仕様に基づき、改ページ、改丁、改段について、ページ先頭に
        　出現した場合は処理をスキップするように変更。
        ・傍線を細線（─）に、二重傍線を太線に変更。
        ・ページの左右中央に対応。
        ・波線に対応。

        プログラミング上の変更点（新たなるバグの源とも）
        ・外字変換をクラスからサブルーチンへ変更しました。
        ・一時ファイルの作成にtempfile を導入。またタグのネスティング処理に
        　対応するためスタック動作にしています。
        ・一部のタグ処理を辞書引きに変更。
        ・傍線、傍点の処理方法を変更。
        ・JIS外字及びUnicode文字の置換処理の位置を変更。ループの重複を
        　減らしました。
        ・定義されていない文字の表記から底本の頁・行情報を削除。
        ・'%s/%s' % (dir, file) を os.path.join(dir,file) に変更。（URLは除く)
        ・文字描画の設定をcairo.ANTIALIAS_DEFAULTに変更。
        ・テキスト冒頭（作品の表題、著者名等）の表示処理を変更。青空文庫の
        　規定に基づき最初の空行の出現で区切るようにしました。
        ・ダウンロードしたアーカイブの中にtxtファイルが含まれるかチェックする
        　処理を追加。
        ・ダウンロード時、ローカルに既存する場合は上書きするか問い合わせる
        　処理を追加。
        ・青空文庫形式の注記タグ［＃］のネスティングに暫定対応。
        ・formater をイテレータに変更。
        ・くの字記号の分離阻止を行末禁則処理に統合。
        ・未実装タグ除去の処理ルーチンを変更。
        ・フッタ検出を修正。
        ・傍線・傍点の処理を整理
        ・PEP 8 (Style Guide for Python Code)を見てコードを一部修正。

        バグフィックス
        ・ローカル保存されているテキストから作品名や著者名の取り出しに失敗する。
        ・開けないテキストがある（行頭禁則処理のバグ）。
        ・pangoタグが次行にまたがった際の禁則処理が間違っている。
        ・ルビ行のフォントサイズが本文行の半分に固定されている。
        ・hogehoge［＃「hogehoge」はホニャララ］形式のタグ処理にて、hogehoge
        　の前方参照に失敗することがある。
        　前方の hogehoge が hogehoge foo の場合、無限ループに陥る。
        ・アクセント分解（リガチャ）の定義漏れ。
        ・行途中に出現する地付き、字上げが動作しない。
        ・文字の大きさ変更が正しくない。3段階以上の大小には対応していません。
        　第3段階以上は第3段階となります。
        ・見出し等において文末のルビが欠落する。
        ・大見出し時に表示されない。
        ・地付きで1行に収まらない場合無限ループに陥る。
        ・字詰と地付きが連続すると無限ループに陥る。
        ・組み合わさって出現する返り点（一レ等）を検出できない。
        ・新着情報にてweb上に後続のページがない場合、リストが取得できない。
        　（年初だから検出できたバグ）。
        ・途中に改行を含む傍線及び傍点を正しく処理できない。
        ・イレギュラーなヘッダに遭遇すると本文そのものの読み込みに失敗する。
        ・キャプションが正しく表示されない。
        ・複数行に及ぶ見出しが正しく表示されない。
        ・目次作成が正しく行えない。

    ２０１４年１２月
        バグフィックス
        ・ローカル保存ファイル選択ダイアログのバグを修正。
        ・折り返し記号処理ルーチンのバグを修正。
        ・画像ファイルの読み込みに失敗するバグを修正。
        ・見出し処理の際、途中にルビがあると正しく表示されないバグを修正。
        ・ブロックインデントのバグ修正。
        ・Pangoタグ取扱い時のバグを修正。
        ・見出しの処理を修正。複数行見出しには未だ対応せず。
        ・禁則処理のバグを修正。
        ・外字の検出及び置換のバグを修正。

        変更点
        ・ライセンスをGPL2へ変更。
        ・動作確認環境に花園明朝を追加。OSにインストールすることで、
        　TakaoEx明朝にないUnicode文字が表示されるようになります。
        ・WXGA(XGA越)時のウインドウサイズを変更。

        追加された機能等
        UI
        ・メニュー
            読書履歴（いわゆる最近使用したファイル）
            ログファイルビューワ (logview.py)。
        ・ダイアログ
            ローカル保存の青空文庫一覧を新規差し替え。
        ・キー操作
            ページ戻り　                    shift + space
            ダイアログのキャンセル　         ESC
            新着情報の呼び出し               CTRL_N
            青空文庫にアクセス（著者別索引）  CTRL_F
            先頭ページ                       Home
            最終ページ                       End
            前ページ                         PgUp
            後ページ                         PgDn
        ・デバッグメッセージを標準出力から ~/.cache/aozora/aozora.log へ変更
        　(logging による)。

        フォーマッタ関連
        ・左傍線、左二重傍線、斜体、太字、地付き、字上げ、字詰
        ・ママ表記、ルビのママ表示
        ・返り点、訓点送り仮名を pango のタグを用いて一部対応。
            送り仮名（右寄せ小文字）　<sup></sup>
            返り点（左寄せ小文字） <sub></sub>
        ・下付き小文字、上付き小文字を pango のタグを用いて一部対応。
            数式に英単語が混ざると横組みで表示されます。英文字1文字だけの
            場合は縦書きのままです。
        ・行右小書きに部分対応。
        ・文字の大きさの指定に暫定的に対応
        ・JIS及びUnicode未定義の小書き片仮名にとりあえず対応。
        　※［＃小書き片仮名ヱ、1-234］等、ランボオ詩集/中原中也訳
        ・pango.Layoutのset_markupでエラーになる & < > を 各々&amp; &lt;
        　&gt; に置換。
        ・外字のUnicode指定に対応。但し、TakaoEx明朝等、JIS未登録文字に対応して
        　いないフォントでは正しく表示しません。
        ・英大文字(unicodedata.category() == 'Lu')を全角1文字と同幅として
        　処理するように変更。大文字ばかりの綴りが出現すると桁溢れを起こして読め
        　なくなるため。
        ・挿図タグの揺らぎに対応（踊る人形/大久保ゆう改訳）
        ・フッター部分のアラビア数字を全て漢数字に変換していたものを、年月日刷
        　部分のみに変更。
        ・行頭禁則処理を一部変更
        　２文字目を処理する際、括弧類なら前行末にぶら下げ、小さい仮名文字等は
        　前行から１字もらってくるようにしました。
        ・字下げタグの揺らぎに対応。
        ・見出しのフォントをSansに、大見出しのフォントサイズを larger に変更。
        ・文字変換ルーチンに(jis3.py)JIS1面1区の文字を追加。
        ・一部のタグの揺らぎに対応。
                ［＃(ここから)??横組み］［＃(ここで)??横組み終わり］
        ・<sup></sup>, <sub></sub>については、表示される際の文字幅を考慮
        　していないので、1行に大量に出現すると後続のルビ位置がおかしくなり
        　ます。
        ・［＃本文終わり］に対応。
        ・画像の最大幅を表示領域の半分に制限。

        内部改変された部分等
        ・表示ルーチンの見直し。
        ・JIS3.py を jis3.py へ名称変更。
        ・挿図タグに図のピクセルサイズが正しく記されていない場合があるので、
        　直接に図(pngファイル)を参照してサイズを得る方法に変更。

        削除された機能等
        ・# vim: を削除。
        ・青空文庫の制御文字列である　［＃］を【＃】と表記するテキストへの対応
        　部分を削除。
        　かつて検出されたテキスト(絶対矛盾的自己同一　西田幾多郎)側で修正され
        　ているため。

    ２０１４年７月
        ・新着情報にアクセスする為のダイアログを追加
        ・青空文庫のダウンロードルーチンを readersub.py へ移動。
        ・ばつ傍点等の傍点に対応。
        ・未実装な注記（青空文庫におけるタグ）の読み飛ばしを追加。
        ・二重山括弧を表示できない（ルビを示す注記として処理される）ので、
        　不等号（非常に大きい、小さい）で代替。
        ・フォント設定部分のバグフィックス
        ・解像度によって画像表示位置がずれる件を修正

    ２０１４年３月
        ・青空文庫の著作者欄にある、Webページ(もっぱらWikipedia)への
          リンク機能を追加

    ２０１４年２月
        ・青空文庫へのオンラインアクセス機能を追加
        ・文字フォント及びマージン、行間の指定機能を追加

    ２０１３年１１月
        ・ワンタイム地上げが動作していなかったのを修正
        ・解像度変更機能、フォントサイズ変更機能を追加
        　但し、挿絵の大きさの調整はXGA固定のまま

    ２０１３年１０月
        ・unstable としてバージョン変更。
        ・JIS第3、第4水準の変換ルーチンをモジュールとして分離

    ２０１３年８月
        ・ファイル選択ダイアログにて翻訳物の原著者が表示されなかった点を修正
        ・タグ［＃地付き］に対応
        ・書籍選択及びしおりの各ダイアログにて項目のソート機能を追加
        ・ダブルクォーテーションのノノカギへの変換に対応
        ・作業ディレクトリの参照方法を整理
        ・挿図の表示機能の追加

    ２０１３年７月
        ・青空文庫の制御文字列である　［＃］を【＃】と表記するテキストへの対応
        　(絶対矛盾的自己同一　西田幾多郎)
        ・外字の拾い出しのバグフィックス
        ・傍点の体裁を良くしようとしてかえってレイアウトが崩れた点を修正
        ・傍線に対応
        ・ヘッダ2行目を副題として扱う

    ２０１２年１０月
        ・ファイルオープンダイアログを自作の物に変更。青空文庫ファイルを読み込
        　んで、作品名と著作者名を表示。
        ・傍点、傍線、二重傍線の表示改善。但し、二重傍線は未テスト。
        ・既知の問題
            引き続き、本文に英文字が含まれるとルビ位置が狂う。
            1段落が長くなると、読み込み漏れが起こる。
            例えば、夏目漱石　我輩は猫である
            （デフォルト設定ならば）28頁付近。バッファ切れか？
            極端に大きいファイルを読み込ませようとすると暴走する。

    ２０１２年９月
        ・しおりを開く際に、必ず原ファイル（青空ファイル）を読み込みなおして
        　いたのを現在見ているファイルと同じであれば、読み込みせずにページジャン
        　プするように変更。
        ・フォーマッタ第1パスを次のように変更
            書名、著者名の取得を別ルーチンに書き出して分離。
            置換時に中間ファイルを作成していたのをジェネレータに書き改めた。
            これらによりプログラムの見通しは改善されたが、動作速度の向上は感
            じられず。
        ・ルビの処理
        　青空文庫の仕様に則り、本文における文字種の切り替わり時をルビ先頭として
        　マークするように変更。
        ・ルビ表示の改善。
        　ツール - 移動　のカウンタの上限を設定。
        ・既知の問題
            本文に半角文字が混じるとルビの位置がズレる。
            禁則処理時のルビ位置の調整がおそらく不完全。行末禁則は概ね問題なさ
            そうだが行頭禁則処理は未確認。
        ・ルビ表示へとりあえず対応。表示に等幅フォントを用い、ルビを本文の半分の
        　大きさにすることで簡便に処理している。
        　（ビットマップディスプレイで用いる手法ではないと思う。）
        ・ルビが複数行にまたがる場合、正しく表示できない。
        ・ルビが本文より長い場合、例えば漢字1文字に4文字以上のルビが振ってある
        　場合等では後続の桁がずれる。
        ・傍点をルビに置換して簡易表示。ルビの表示位置の切り出しを漢字、英字、
        　カタカナに限定しているのでひらがなに傍点を打つことが出来ない。
        ・また、REによる置換を行っているが処理がいい加減なので、1段落に複数出現
        　すると正しく表示されない。
        ・ルビ未対応のまま、一旦FIXし、フォーマッタから再度作成しなおし。
        ・formater 分割
        ・くの字　／＼　／゛＼ の　〳〵 〴〵への置換と分割禁止
        ・フッタにおける年月日を漢数字に置換
        ・禁則処理に全角（）等一部が含まれていなかったのを追加。
        ・半角文字が全角文字と同じように1文字としてカウントされていたのを0.5文字
        　としてカウントするように修正。
        ・これにより、等幅フォント使用時であれば英文横書きが混在しても１行に可能
        　な限り文字を詰め込んで表示する。
        ・1文字未満の文字（半角文字数の合計が奇数の場合）は切り捨てる。
        　この際、2重禁則が発生すると1行が長くなって見苦しくなる。
        　（歯車 芥川龍之介）
        ・JIS第3水準、第4水準を実装
        ・ルビ表示領域の調整
        ・初期画面表示の際、処理の重複があった点を修正
        ・フォーマッタ修正
        ・著者及び翻訳者名の解釈が正しくできなかった点を修正
        ・文字装飾のテスト
        ・フォーマット時にタグを挿入し、描画ルーチンで装飾してみる。が、バグっぽい。
        ・改行のみの行が、完全に削除されていたのを修正
        ・外字変換ルーチン（仮）
        ・フォーマッタ修正
        ・青空タグの除去がうまくいかなかった点を改善
        ・目次ジャンプの実装（仮）
        ・行頭禁則処理の2重化

    ２０１２年９月２日
        アルファバージョン脱稿、ベータバージョン開発開始
