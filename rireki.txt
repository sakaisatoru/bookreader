青空文庫リーダー
    GPL2
    ベータバージョン
    ２０１３年７月２７日、　２０１２年９月２日、  ２０１４年１２月７日

    概要
        青空文庫(http://www.aozora.gr.jp)のテキストファイルをPython(CPython)と
        gtk+2.0とPangoを用いて縦書き表示で読もう、というものです。

    開発及び動作確認環境
        PuppyLinux 571JP
            devx.sfs, pygtk及び関連ライブラリ一式
            TakaoEx明朝
            花園明朝A,B

    既知の問題点
    ・右ページ、左ページの概念がありません。このため、改ページと改丁は同じ意味と
    　なります。
    ・文字サイズの変更の際、文字高さ（横組みにおいては文字幅）を配慮しません。
    　このため、標準サイズよりも小さなサイズだけで構成された行は字上げされて
    　表示されます。また、大きいサイズだけで構成された場合は全て表示されません。
    ・本文の文字サイズに大小が混ざるとルビ位置がずれて表示される場合があります。
    ・ルビの禁則処理を行いません。
    ・ネストしたタグは正しく処理されない場合があります。
    ・連続して出現するタグは正しく処理されません。
    　例）我輩《わがはい》［＃「我輩」に傍線］は猫
    　　　我輩の右横にルビ(わがはい)と傍点が表示されなくてはならないが
    　　　実際は我輩(ルビ付き)我輩(傍線付き)と重複して表示される。
    ・本文中に出現する《》はルビを示すタグとして予約されているため、表示されま
    　せん。算術二重不等号≪≫に置換して表示されます。
    ・一部フォントでは正しく表示されません。(M+1P+IPAG等)
    ・pango 1.30.0に不具合があり、一部の文字が正しく表示されません。
    　後続バージョンでは修正されていますが、(PuppyLinux系も含む)他のOSからの
    　バイナリパッケージの流用は避けてください。Xが動作しなくなります。
    ・読書履歴（しおり機能）に解像度や文字の大きさの情報を持たせていないため、
    　これらの設定を変更した後、しおりを開くと意図しないページが表示されます。
    ・挿図処理が不完全で、テキストが下敷きになる場合があります。また、テキスト
    　への埋め込み（数式や特殊な外字を挿図で再現している等）は対応していません。
    ・デバッグ用のメッセージ出力がそのままになっています。

    機能上の制限等
    ・扱えるのは青空文庫のサイトにアップロードされているテキストファイルのみです。
    　これ以外の形式、及びサイト外を参照しているファイルは開くことができません。
    　また、青空文庫の形式に準拠していない構成のファイルは正しく表示されません。
    ・フォントサイズの指定において、デスクトップのdpi情報は無視されます。
    ・青空文庫のサイトから直接開いた場合、ローカルディスク上の既存のファイルは
    　上書きされます。
    ・原則としてunicode にもJISにもない文字はタグのままとなり、フォントへ変換
    　しません。

    フォントの問題
    ・TakaoEx明朝等、JIS未収録文字に対応していないフォントを使っている場合、
    　Unicode指定の外字が表示できません。
    　しかし、システムによっては他のフォントを併用できる場合があります。
    　以下にPuppyLinux571JPでの例を示します。なお、インストール時には相応の
    　ディスクスペースを使います。また、実行時の消費メモリも増えますのでご注意
    　願います。(実装RAM1GB以上を推奨します。）
        ０）既にTakaoEx明朝がインストールされているものとします。
        １）Hanazono fonts (http://fonts.jp/hanazono/)より花園明朝の
        　　フォントファイルをダウンロードします。
        ２）圧縮ファイル展開後に作成される、
        　　HanaMinA.ttf, HanaMinB.ttfを
        　　/usr/share/fonts/default/TTFへコピーします。
        ３）/usr/share/fonts/default/TTFにて、
        　  mkfontdir
            mkfontscale
            fc-cache -f
            を順に実行します。
        ４）Xを再起動します。
        これでTakaoEx明朝だけでは表示されない文字も表示されるようになります。

    開発履歴
    ２０１５年1月
        既存のバグ
        ・同一文字に複数のタグがかかると正常に表示されないバグ。
        ・キャプションの表示にバグ。
        ・稀にダウンロード直後の表示に失敗するバグ。
        　UnicodeDecodeError: 'shift_jis' codec can't decode bytes in
        　position 35-36: illegal multibyte sequence
        ・複数行に及ぶ見出しの処理にバグ。
        ・同じくメニュー登録が不完全なバグ。
        ・モジュール設計が適当過ぎて酷いので後日修正予定。

    ２０１５年１月１日
        ・ページの左右中央に対応。

    ２０１４年１２月
        バグフィックス
        ・ローカル保存ファイル選択ダイアログのバグを修正。
        ・折り返し記号処理ルーチンのバグを修正。
        ・画像ファイルの読み込みに失敗するバグを修正。
        ・見出し処理の際、途中にルビがあると正しく表示されないバグを修正。
        ・ブロックインデントのバグ修正。
        ・Pangoタグ取扱い時のバグを修正。
        ・見出しの処理を修正。複数行見出しには未だ対応せず。
        ・禁則処理のバグを修正。
        ・外字の検出及び置換のバグを修正。

        変更点
        ・ライセンスをGPL2へ変更。
        ・動作確認環境に花園明朝を追加。OSにインストールすることで、
        　TakaoEx明朝にないUnicode文字が表示されるようになります。
        ・WXGA(XGA越)時のウインドウサイズを変更。

        追加された機能等
        UI
        ・メニュー
            読書履歴（いわゆる最近使用したファイル）
            ログファイルビューワ (logview.py)。
        ・ダイアログ
            ローカル保存の青空文庫一覧を新規差し替え。
        ・キー操作
            ページ戻り　                    shift + space
            ダイアログのキャンセル　         ESC
            新着情報の呼び出し               CTRL_N
            青空文庫にアクセス（著者別索引）  CTRL_F
            先頭ページ                       Home
            最終ページ                       End
            前ページ                         PgUp
            後ページ                         PgDn
        ・デバッグメッセージを標準出力から ~/.cache/aozora/aozora.log へ変更
        　(logging による)。

        フォーマッタ関連
        ・左傍線、左二重傍線、斜体、太字、地付き、字上げ、字詰
        ・ママ表記、ルビのママ表示
        ・返り点、訓点送り仮名を pango のタグを用いて一部対応。
            送り仮名（右寄せ小文字）　<sup></sup>
            返り点（左寄せ小文字） <sub></sub>
        ・下付き小文字、上付き小文字を pango のタグを用いて一部対応。
            数式に英単語が混ざると横組みで表示されます。英文字1文字だけの
            場合は縦書きのままです。
        ・行右小書きに部分対応。
        ・文字の大きさの指定に暫定的に対応
        ・JIS及びUnicode未定義の小書き片仮名にとりあえず対応。
        　※［＃小書き片仮名ヱ、1-234］等、ランボオ詩集/中原中也訳
        ・pango.Layoutのset_markupでエラーになる & < > を 各々&amp; &lt;
        　&gt; に置換。
        ・外字のUnicode指定に対応。但し、TakaoEx明朝等、JIS未登録文字に対応して
        　いないフォントでは正しく表示しません。
        ・英大文字(unicodedata.category() == 'Lu')を全角1文字と同幅として
        　処理するように変更。大文字ばかりの綴りが出現すると桁溢れを起こして読め
        　なくなるため。
        ・挿図タグの揺らぎに対応（踊る人形/大久保ゆう改訳）
        ・フッター部分のアラビア数字を全て漢数字に変換していたものを、年月日刷
        　部分のみに変更。
        ・行頭禁則処理を一部変更
        　２文字目を処理する際、括弧類なら前行末にぶら下げ、小さい仮名文字等は
        　前行から１字もらってくるようにしました。
        ・字下げタグの揺らぎに対応。
        ・見出しのフォントをSansに、大見出しのフォントサイズを larger に変更。
        ・文字変換ルーチンに(jis3.py)JIS1面1区の文字を追加。
        ・一部のタグの揺らぎに対応。
                ［＃(ここから)??横組み］［＃(ここで)??横組み終わり］
        ・<sup></sup>, <sub></sub>については、表示される際の文字幅を考慮
        　していないので、1行に大量に出現すると後続のルビ位置がおかしくなり
        　ます。
        ・［＃本文終わり］に対応。
        ・画像の最大幅を表示領域の半分に制限。

        内部改変された部分等
        ・表示ルーチンの見直し。
        ・JIS3.py を jis3.py へ名称変更。
        ・挿図タグに図のピクセルサイズが正しく記されていない場合があるので、
        　直接に図(pngファイル)を参照してサイズを得る方法に変更。

        削除された機能等
        ・# vim: を削除。
        ・青空文庫の制御文字列である　［＃］を【＃】と表記するテキストへの対応
        　部分を削除。
        　かつて検出されたテキスト(絶対矛盾的自己同一　西田幾多郎)側で修正され
        　ているため。

    ２０１４年７月
        ・新着情報にアクセスする為のダイアログを追加
        ・青空文庫のダウンロードルーチンを readersub.py へ移動。
        ・ばつ傍点等の傍点に対応。
        ・未実装な注記（青空文庫におけるタグ）の読み飛ばしを追加。
        ・二重山括弧を表示できない（ルビを示す注記として処理される）ので、
        　不等号（非常に大きい、小さい）で代替。
        ・フォント設定部分のバグフィックス
        ・解像度によって画像表示位置がずれる件を修正

    ２０１４年３月
        ・青空文庫の著作者欄にある、Webページ(もっぱらWikipedia)への
          リンク機能を追加

    ２０１４年２月
        ・青空文庫へのオンラインアクセス機能を追加
        ・文字フォント及びマージン、行間の指定機能を追加

    ２０１３年１１月
        ・ワンタイム地上げが動作していなかったのを修正
        ・解像度変更機能、フォントサイズ変更機能を追加
        　但し、挿絵の大きさの調整はXGA固定のまま

    ２０１３年１０月
        ・unstable としてバージョン変更。
        ・JIS第3、第4水準の変換ルーチンをモジュールとして分離

    ２０１３年８月
        ・ファイル選択ダイアログにて翻訳物の原著者が表示されなかった点を修正
        ・タグ［＃地付き］に対応
        ・書籍選択及びしおりの各ダイアログにて項目のソート機能を追加
        ・ダブルクォーテーションのノノカギへの変換に対応
        ・作業ディレクトリの参照方法を整理
        ・挿図の表示機能の追加

    ２０１３年７月
        ・青空文庫の制御文字列である　［＃］を【＃】と表記するテキストへの対応
        　(絶対矛盾的自己同一　西田幾多郎)
        ・外字の拾い出しのバグフィックス
        ・傍点の体裁を良くしようとしてかえってレイアウトが崩れた点を修正
        ・傍線に対応
        ・ヘッダ2行目を副題として扱う

    ２０１２年１０月
        ・ファイルオープンダイアログを自作の物に変更。青空文庫ファイルを読み込
        　んで、作品名と著作者名を表示。
        ・傍点、傍線、二重傍線の表示改善。但し、二重傍線は未テスト。
        ・既知の問題
            引き続き、本文に英文字が含まれるとルビ位置が狂う。
            1段落が長くなると、読み込み漏れが起こる。
            例えば、夏目漱石　我輩は猫である
            （デフォルト設定ならば）28頁付近。バッファ切れか？
            極端に大きいファイルを読み込ませようとすると暴走する。

    ２０１２年９月
        ・しおりを開く際に、必ず原ファイル（青空ファイル）を読み込みなおして
        　いたのを現在見ているファイルと同じであれば、読み込みせずにページジャン
        　プするように変更。
        ・フォーマッタ第1パスを次のように変更
            書名、著者名の取得を別ルーチンに書き出して分離。
            置換時に中間ファイルを作成していたのをジェネレータに書き改めた。
            これらによりプログラムの見通しは改善されたが、動作速度の向上は感
            じられず。
        ・ルビの処理
        　青空文庫の仕様に則り、本文における文字種の切り替わり時をルビ先頭として
        　マークするように変更。
        ・ルビ表示の改善。
        　ツール - 移動　のカウンタの上限を設定。
        ・既知の問題
            本文に半角文字が混じるとルビの位置がズレる。
            禁則処理時のルビ位置の調整がおそらく不完全。行末禁則は概ね問題なさ
            そうだが行頭禁則処理は未確認。
        ・ルビ表示へとりあえず対応。表示に等幅フォントを用い、ルビを本文の半分の
        　大きさにすることで簡便に処理している。
        　（ビットマップディスプレイで用いる手法ではないと思う。）
        ・ルビが複数行にまたがる場合、正しく表示できない。
        ・ルビが本文より長い場合、例えば漢字1文字に4文字以上のルビが振ってある
        　場合等では後続の桁がずれる。
        ・傍点をルビに置換して簡易表示。ルビの表示位置の切り出しを漢字、英字、
        　カタカナに限定しているのでひらがなに傍点を打つことが出来ない。
        ・また、REによる置換を行っているが処理がいい加減なので、1段落に複数出現
        　すると正しく表示されない。
        ・ルビ未対応のまま、一旦FIXし、フォーマッタから再度作成しなおし。
        ・formater 分割
        ・くの字　／＼　／゛＼ の　〳〵 〴〵への置換と分割禁止
        ・フッタにおける年月日を漢数字に置換
        ・禁則処理に全角（）等一部が含まれていなかったのを追加。
        ・半角文字が全角文字と同じように1文字としてカウントされていたのを0.5文字
        　としてカウントするように修正。
        ・これにより、等幅フォント使用時であれば英文横書きが混在しても１行に可能
        　な限り文字を詰め込んで表示する。
        ・1文字未満の文字（半角文字数の合計が奇数の場合）は切り捨てる。
        　この際、2重禁則が発生すると1行が長くなって見苦しくなる。
        　（歯車 芥川龍之介）
        ・JIS第3水準、第4水準を実装
        ・ルビ表示領域の調整
        ・初期画面表示の際、処理の重複があった点を修正
        ・フォーマッタ修正
        ・著者及び翻訳者名の解釈が正しくできなかった点を修正
        ・文字装飾のテスト
        ・フォーマット時にタグを挿入し、描画ルーチンで装飾してみる。が、バグっぽい。
        ・改行のみの行が、完全に削除されていたのを修正
        ・外字変換ルーチン（仮）
        ・フォーマッタ修正
        ・青空タグの除去がうまくいかなかった点を改善
        ・目次ジャンプの実装（仮）
        ・行頭禁則処理の2重化

    ２０１２年９月２日
        アルファバージョン脱稿、ベータバージョン開発開始